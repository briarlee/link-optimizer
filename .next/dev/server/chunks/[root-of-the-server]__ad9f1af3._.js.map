{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/briar/Downloads/link-optimizer/src/app/api/search/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { ExternalLink } from '@/types';\n\nconst GOOGLE_API_KEY = process.env.GOOGLE_SEARCH_API_KEY || 'AIzaSyCncGGmUfqzZGbZ9YnZfPg_6_-2zx8Ch10';\nconst SEARCH_ENGINE_ID = process.env.GOOGLE_SEARCH_ENGINE_ID || '';\n\ninterface GoogleSearchResult {\n  items?: Array<{\n    title: string;\n    link: string;\n    snippet: string;\n    displayLink: string;\n  }>;\n}\n\nasync function searchGoogle(query: string, preferredDomains: string[] = [], blacklistedDomains: string[] = []): Promise<ExternalLink[]> {\n  // 如果没有配置 Search Engine ID，使用备用方案\n  if (!SEARCH_ENGINE_ID) {\n    return generateFallbackLinks(query);\n  }\n\n  try {\n    const url = new URL('https://www.googleapis.com/customsearch/v1');\n    url.searchParams.set('key', GOOGLE_API_KEY);\n    url.searchParams.set('cx', SEARCH_ENGINE_ID);\n    url.searchParams.set('q', query);\n    url.searchParams.set('num', '10');\n\n    const response = await fetch(url.toString());\n    \n    if (!response.ok) {\n      console.error('Google Search API error:', await response.text());\n      return generateFallbackLinks(query);\n    }\n\n    const data: GoogleSearchResult = await response.json();\n    \n    if (!data.items || data.items.length === 0) {\n      return generateFallbackLinks(query);\n    }\n\n    // 过滤黑名单\n    let results = data.items.filter(item => \n      !blacklistedDomains.some(domain => item.link.includes(domain))\n    );\n\n    // 优先排序偏好域名\n    results.sort((a, b) => {\n      const aPreferred = preferredDomains.some(d => a.link.includes(d)) ? -1 : 0;\n      const bPreferred = preferredDomains.some(d => b.link.includes(d)) ? -1 : 0;\n      return aPreferred - bPreferred;\n    });\n\n    return results.slice(0, 5).map(item => ({\n      url: item.link,\n      title: item.title,\n      snippet: item.snippet,\n      source: item.displayLink,\n    }));\n  } catch (error) {\n    console.error('Search error:', error);\n    return generateFallbackLinks(query);\n  }\n}\n\n// 备用方案：生成基于关键词的权威网站链接\nfunction generateFallbackLinks(query: string): ExternalLink[] {\n  const queryLower = query.toLowerCase();\n  const links: ExternalLink[] = [];\n\n  // 教育相关\n  if (queryLower.includes('education') || queryLower.includes('learning') || \n      queryLower.includes('montessori') || queryLower.includes('preschool') ||\n      queryLower.includes('kindergarten') || queryLower.includes('child')) {\n    links.push(\n      {\n        url: `https://en.wikipedia.org/wiki/${encodeURIComponent(query.replace(/\\s+/g, '_'))}`,\n        title: `${query} - Wikipedia`,\n        snippet: `Learn more about ${query} on Wikipedia, the free encyclopedia.`,\n        source: 'wikipedia.org',\n      },\n      {\n        url: `https://www.naeyc.org/search?search=${encodeURIComponent(query)}`,\n        title: `${query} - NAEYC`,\n        snippet: `Resources about ${query} from the National Association for the Education of Young Children.`,\n        source: 'naeyc.org',\n      }\n    );\n  }\n\n  // 安全/认证相关\n  if (queryLower.includes('safety') || queryLower.includes('certification') ||\n      queryLower.includes('standard') || queryLower.includes('regulation')) {\n    links.push({\n      url: `https://www.cpsc.gov/Safety-Education`,\n      title: 'Safety Education - CPSC',\n      snippet: 'Consumer Product Safety Commission safety resources and guidelines.',\n      source: 'cpsc.gov',\n    });\n  }\n\n  // 通用 Wikipedia 链接\n  if (links.length === 0) {\n    links.push({\n      url: `https://en.wikipedia.org/wiki/${encodeURIComponent(query.replace(/\\s+/g, '_'))}`,\n      title: `${query} - Wikipedia`,\n      snippet: `Learn more about ${query} on Wikipedia.`,\n      source: 'wikipedia.org',\n    });\n  }\n\n  // 添加 Google Scholar 链接\n  links.push({\n    url: `https://scholar.google.com/scholar?q=${encodeURIComponent(query)}`,\n    title: `${query} - Google Scholar`,\n    snippet: `Academic articles and research about ${query}.`,\n    source: 'scholar.google.com',\n  });\n\n  return links;\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { keyword, preferredDomains = [], blacklistedDomains = [] } = await request.json();\n\n    if (!keyword) {\n      return NextResponse.json(\n        { success: false, error: 'Keyword is required' },\n        { status: 400 }\n      );\n    }\n\n    const links = await searchGoogle(keyword, preferredDomains, blacklistedDomains);\n\n    return NextResponse.json({\n      success: true,\n      data: links,\n    });\n  } catch (error) {\n    console.error('Search route error:', error);\n    return NextResponse.json(\n      { success: false, error: 'Search failed' },\n      { status: 500 }\n    );\n  }\n}\n\n// 批量搜索\nexport async function PUT(request: NextRequest) {\n  try {\n    const { keywords, preferredDomains = [], blacklistedDomains = [] } = await request.json();\n\n    if (!keywords || !Array.isArray(keywords)) {\n      return NextResponse.json(\n        { success: false, error: 'Keywords array is required' },\n        { status: 400 }\n      );\n    }\n\n    const results: Record<string, ExternalLink[]> = {};\n\n    // 串行搜索避免 API 限制\n    for (const keyword of keywords.slice(0, 10)) {\n      results[keyword] = await searchGoogle(keyword, preferredDomains, blacklistedDomains);\n      // 添加小延迟避免触发 rate limit\n      await new Promise(resolve => setTimeout(resolve, 200));\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: results,\n    });\n  } catch (error) {\n    console.error('Batch search error:', error);\n    return NextResponse.json(\n      { success: false, error: 'Batch search failed' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}