{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/briar/Downloads/link-optimizer/src/app/api/analyze/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { InternalPage, KeywordResult, SuggestedLink } from '@/types';\n\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY || 'AIzaSyCOStcZT9mG4zqPUl21lm1HTPifPDb6MFo';\n\ninterface GeminiResponse {\n  candidates?: Array<{\n    content?: {\n      parts?: Array<{\n        text?: string;\n      }>;\n    };\n  }>;\n}\n\nasync function callGemini(prompt: string): Promise<string> {\n  const response = await fetch(\n    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,\n    {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        contents: [\n          {\n            parts: [{ text: prompt }],\n          },\n        ],\n        generationConfig: {\n          temperature: 0.3,\n          maxOutputTokens: 4096,\n        },\n      }),\n    }\n  );\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(`Gemini API error: ${response.status} - ${errorText}`);\n  }\n\n  const data: GeminiResponse = await response.json();\n  return data.candidates?.[0]?.content?.parts?.[0]?.text || '';\n}\n\nfunction matchInternalLinks(keywords: string[], internalPages: InternalPage[]): Map<string, SuggestedLink[]> {\n  const matches = new Map<string, SuggestedLink[]>();\n\n  for (const keyword of keywords) {\n    const keywordLower = keyword.toLowerCase();\n    const keywordWords = keywordLower.split(/\\s+/);\n    const suggestions: SuggestedLink[] = [];\n\n    for (const page of internalPages) {\n      let score = 0;\n      const titleLower = page.title.toLowerCase();\n      const urlLower = page.url.toLowerCase();\n      const descLower = page.description.toLowerCase();\n\n      // 完整关键词匹配（高权重）\n      if (titleLower.includes(keywordLower)) {\n        score += 60;\n      }\n\n      // 单词级别匹配\n      for (const word of keywordWords) {\n        if (word.length < 3) continue; // 跳过太短的词\n        \n        if (titleLower.includes(word)) {\n          score += 25;\n        }\n        if (urlLower.includes(word)) {\n          score += 20;\n        }\n        if (descLower.includes(word)) {\n          score += 15;\n        }\n      }\n\n      // 页面关键词匹配\n      for (const pageKeyword of page.keywords) {\n        const pkLower = pageKeyword.toLowerCase();\n        if (pkLower.includes(keywordLower) || keywordLower.includes(pkLower)) {\n          score += 30;\n        }\n        // 单词匹配\n        for (const word of keywordWords) {\n          if (word.length >= 3 && pkLower.includes(word)) {\n            score += 15;\n          }\n        }\n      }\n\n      if (score > 20) { // 降低阈值\n        suggestions.push({\n          url: page.url,\n          title: page.title,\n          description: page.description || page.url,\n          type: 'internal',\n          relevanceScore: Math.min(score, 100),\n        });\n      }\n    }\n\n    // 按相关性排序\n    suggestions.sort((a, b) => b.relevanceScore - a.relevanceScore);\n    matches.set(keyword, suggestions.slice(0, 5)); // 增加到5个建议\n  }\n\n  return matches;\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { text, internalPages = [] } = await request.json();\n\n    if (!text || text.trim().length === 0) {\n      return NextResponse.json(\n        { success: false, error: 'Text is required' },\n        { status: 400 }\n      );\n    }\n\n    // 构建提示词\n    const prompt = `Analyze the following English text and identify keywords/phrases that would benefit from hyperlinks. Focus on:\n1. Technical terms and concepts\n2. Product/service names\n3. Industry-specific terminology\n4. Proper nouns (companies, places, etc.)\n5. Key topics that readers might want to learn more about\n\nFor each keyword, determine if it's better suited for:\n- \"internal\": Topics the website might have content about\n- \"external\": General knowledge or authoritative external sources\n- \"both\": Could benefit from either type\n\nReturn a JSON array with this exact format (no markdown, just pure JSON):\n[\n  {\n    \"keyword\": \"the exact phrase from the text\",\n    \"type\": \"internal|external|both\",\n    \"context\": \"brief explanation of why this needs a link\",\n    \"position\": approximate character position in text\n  }\n]\n\nText to analyze:\n\"\"\"\n${text.slice(0, 8000)}\n\"\"\"\n\nImportant: \n- Only return valid JSON, no other text\n- Limit to 15 most important keywords\n- Keywords should be 1-4 words\n- Position should be the approximate character index where this keyword first appears`;\n\n    const geminiResponse = await callGemini(prompt);\n    \n    // 解析 JSON 响应\n    let keywords: KeywordResult[] = [];\n    try {\n      // 尝试从响应中提取 JSON\n      const jsonMatch = geminiResponse.match(/\\[[\\s\\S]*\\]/);\n      if (jsonMatch) {\n        keywords = JSON.parse(jsonMatch[0]);\n      }\n    } catch (parseError) {\n      console.error('Failed to parse Gemini response:', parseError);\n      console.log('Raw response:', geminiResponse);\n    }\n\n    // 匹配内链\n    const internalMatches = matchInternalLinks(\n      keywords.map(k => k.keyword),\n      internalPages\n    );\n\n    // 合并结果\n    const results: KeywordResult[] = keywords.map(k => ({\n      ...k,\n      suggestedLinks: internalMatches.get(k.keyword) || [],\n    }));\n\n    return NextResponse.json({\n      success: true,\n      data: results,\n    });\n  } catch (error) {\n    console.error('Analyze error:', error);\n    return NextResponse.json(\n      { success: false, error: error instanceof Error ? error.message : 'Analysis failed' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}